<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Insightful Sales Overview</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 12px; background: #f6f9fc; color: #222; }
    h2 { text-align: center; margin-bottom: 8px; }
    .chart-wrap { max-width: 900px; margin: 12px auto; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    canvas { width: 100% !important; height: auto !important; }
    .note { font-size: 13px; color: #555; text-align: center; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Insightful Sales Overview</h2>

  <div class="chart-wrap">
    <canvas id="barChart"></canvas>
  </div>

  <div class="chart-wrap">
    <canvas id="pieChart"></canvas>
  </div>

  <p class="note">This page accepts data either via URL query string (<code>?labels=...&values=...</code>) or by sending a message from the WebViewer (postMessage). Labels must be separated by <code>|</code> and values by <code>,</code>.</p>

<script>
// Globals for Chart.js instances
let barChart = null;
let pieChart = null;

function generateColors(n){
  const palette = ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ac'];
  const out = [];
  for(let i=0;i<n;i++) out.push(palette[i % palette.length]);
  return out;
}

function renderCharts(labels, values){
  if(!labels || !values) return;
  // ensure values are numbers
  values = values.map(v => {
    let n = Number(v);
    return isNaN(n) ? 0 : n;
  });

  const colors = generateColors(labels.length);

  // BAR CHART
  const barCtx = document.getElementById('barChart').getContext('2d');
  if(barChart){
    barChart.data.labels = labels;
    barChart.data.datasets[0].data = values;
    barChart.update();
  } else {
    barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Sales',
          data: values,
          backgroundColor: colors,
          borderColor: colors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // PIE CHART
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(pieChart){
    pieChart.data.labels = labels;
    pieChart.data.datasets[0].data = values;
    pieChart.update();
  } else {
    pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
}

// parse query string (labels=...&values=...)
// labels expected separated by '|' ; values separated by ','
function tryLoadFromQuery(){
  try {
    const params = new URLSearchParams(window.location.search);
    const l = params.get('labels');
    const v = params.get('values');
    if(l && v){
      const labels = decodeURIComponent(l).split('|').map(s => s.trim()).filter(s => s !== "");
      const values = decodeURIComponent(v).split(',').map(s => s.trim()).filter(s => s !== "");
      renderCharts(labels, values);
    }
  } catch(e){ console.warn('query parse error', e); }
}

// listen for postMessage (from Thunkable WebViewer)
// message should be a JSON string like: {"labels":"P1|P2|P3","values":"10,20,5"}
window.addEventListener('message', function(event){
  try {
    // event.data can be string or object
    let payload = event.data;
    if(typeof payload === 'string'){
      payload = JSON.parse(payload);
    }
    if(payload && payload.labels && payload.values){
      const labels = String(payload.labels).split('|').map(s => s.trim()).filter(s => s !== "");
      const values = String(payload.values).split(',').map(s => s.trim()).filter(s => s !== "");
      renderCharts(labels, values);
    } else {
      console.warn('message received but missing labels/values', payload);
    }
  } catch(err){
    console.warn('postMessage parse error', err);
  }
}, false);

// try immediately when page loads with query string
tryLoadFromQuery();
</script>
</body>
</html>
